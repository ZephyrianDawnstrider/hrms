# Security Setup Guide

## ‚ö†Ô∏è IMPORTANT: Database Credentials Security

**NEVER hardcode database credentials in your code!** This is a critical security issue.

## Current Database Setup

### Local Development
- **Database**: SQLite (`db.sqlite3`)
- **No credentials needed**: SQLite is file-based
- **DATABASE_URL**: Not set (uses SQLite by default)

### Production (Render)
- **Database**: PostgreSQL (from Render's internal database)
- **Credentials**: Set via Render's environment variables
- **DATABASE_URL**: Automatically provided by Render when you link the database

## How to Set Up DATABASE_URL on Render

### Option 1: Link Render PostgreSQL Database (Recommended)

1. **In Render Dashboard:**
   - Go to your PostgreSQL database service
   - Copy the **Internal Database URL**
   
2. **In your Web Service:**
   - Go to Environment tab
   - Add environment variable:
     - Key: `DATABASE_URL`
     - Value: Paste the Internal Database URL
   
3. **Render will automatically:**
   - Inject this URL into your application
   - Keep it secure (not visible in logs)
   - Update it if database credentials change

### Option 2: Use Render's Database Linking (Easiest)

1. **In Render Dashboard:**
   - Go to your web service
   - Click "Environment" tab
   - Scroll to "Environment Variables"
   - Click "Add from Database"
   - Select your PostgreSQL database
   - Render automatically creates `DATABASE_URL`

## Environment Variables Setup

### Required Environment Variables on Render

Set these in Render Dashboard ‚Üí Your Service ‚Üí Environment:

```
SECRET_KEY=<auto-generated-by-render>
DEBUG=False
DATABASE_URL=<from-render-database>
ALLOWED_HOSTS=your-app-name.onrender.com
CSRF_TRUSTED_ORIGINS=https://your-app-name.onrender.com
```

### How to Set Each Variable

1. **SECRET_KEY**
   - Already set in `render.yaml` with `generateValue: true`
   - Render auto-generates a secure key
   - ‚úÖ No action needed

2. **DEBUG**
   - Already set in `render.yaml` to `False`
   - ‚úÖ No action needed

3. **DATABASE_URL** ‚ö†Ô∏è IMPORTANT
   - **Method 1**: Link database in Render UI
   - **Method 2**: Manually add from database's Internal URL
   - **DO NOT** hardcode in `render.yaml`
   - **DO NOT** commit to Git

4. **ALLOWED_HOSTS**
   - Set to your Render domain
   - Example: `hrms-lite.onrender.com`
   - Can add multiple: `hrms-lite.onrender.com,custom-domain.com`

5. **CSRF_TRUSTED_ORIGINS**
   - Set to your full URL with protocol
   - Example: `https://hrms-lite.onrender.com`
   - Can add multiple: `https://hrms-lite.onrender.com,https://custom-domain.com`

## Security Best Practices

### ‚úÖ DO:
- Use environment variables for all sensitive data
- Use Render's database linking feature
- Keep `.env` file in `.gitignore`
- Use `.env.example` as a template (no real values)
- Rotate credentials periodically
- Use strong, unique passwords

### ‚ùå DON'T:
- Hardcode credentials in code
- Commit `.env` file to Git
- Share credentials in chat/email
- Use the same password across services
- Expose database URLs in logs
- Push credentials to public repositories

## Checking Your Setup

### Verify .gitignore

Make sure `.gitignore` includes:
```
.env
*.sqlite3
db.sqlite3
db_backup.sqlite3
```

### Verify No Credentials in Code

Search your codebase for:
- ‚ùå Hardcoded passwords
- ‚ùå Database URLs with credentials
- ‚ùå API keys
- ‚ùå Secret keys

All should be loaded from environment variables using `os.environ.get()`.

## Current Implementation Status

### ‚úÖ Secure:
- `settings.py` uses `os.environ.get('DATABASE_URL')`
- No hardcoded credentials in settings
- `.env.example` provided (no real values)
- `render.yaml` uses `sync: false` for DATABASE_URL

### ‚ö†Ô∏è Action Required:
1. Set `DATABASE_URL` in Render's environment variables
2. Set `ALLOWED_HOSTS` in Render's environment variables
3. Set `CSRF_TRUSTED_ORIGINS` in Render's environment variables

## Step-by-Step: Setting Up on Render

### Step 1: Create PostgreSQL Database (if not done)
```
1. Render Dashboard ‚Üí New ‚Üí PostgreSQL
2. Name: hrms-database
3. Plan: Free
4. Create Database
5. Wait for provisioning
```

### Step 2: Link Database to Web Service
```
1. Go to your web service (hrms-lite)
2. Click "Environment" tab
3. Scroll to "Environment Variables"
4. Click "Add from Database"
5. Select your PostgreSQL database
6. Render creates DATABASE_URL automatically
```

### Step 3: Set Other Environment Variables
```
1. Still in Environment tab
2. Add ALLOWED_HOSTS:
   - Key: ALLOWED_HOSTS
   - Value: hrms-lite.onrender.com (your actual domain)
   
3. Add CSRF_TRUSTED_ORIGINS:
   - Key: CSRF_TRUSTED_ORIGINS
   - Value: https://hrms-lite.onrender.com (your actual URL)
```

### Step 4: Deploy
```
1. Commit your code (without credentials!)
2. Push to GitHub
3. Render auto-deploys
4. Check logs for successful migration
```

## Troubleshooting

### Issue: "No DATABASE_URL found"
**Solution**: Set DATABASE_URL in Render environment variables

### Issue: "Database connection failed"
**Solution**: 
1. Verify DATABASE_URL is correct
2. Check database is running
3. Verify internal URL (not external)

### Issue: "CSRF verification failed"
**Solution**: Add your domain to CSRF_TRUSTED_ORIGINS

### Issue: "DisallowedHost"
**Solution**: Add your domain to ALLOWED_HOSTS

## Database URL Format

### PostgreSQL Internal URL (Render)
```
postgresql://username:password@hostname/database_name
```

Example structure (DO NOT use this exact URL):
```
postgresql://hrms_user:random_password@dpg-xxxxx-a/hrms_db
```

### Where to Find It
1. Render Dashboard
2. Your PostgreSQL database
3. "Info" tab
4. Copy "Internal Database URL"

## Summary

‚úÖ **Current Status:**
- Code is secure (no hardcoded credentials)
- Uses environment variables properly
- Ready for deployment

‚ö†Ô∏è **Before Deploying:**
1. Set DATABASE_URL in Render (from database)
2. Set ALLOWED_HOSTS in Render
3. Set CSRF_TRUSTED_ORIGINS in Render
4. Verify .gitignore includes .env
5. Never commit real credentials

üîí **Security Checklist:**
- [ ] No credentials in code
- [ ] .env in .gitignore
- [ ] DATABASE_URL from Render environment
- [ ] All sensitive data in environment variables
- [ ] render.yaml has no hardcoded credentials
